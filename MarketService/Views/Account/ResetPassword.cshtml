@{
    ViewData["Title"] = "ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u";
}

@section Styles {
    <link rel="stylesheet" href="~/css/auth.css" asp-append-version="true" />
}

<div class="auth-page-wrapper">
    <div class="auth-card">
        <div class="auth-header">
            <span class="auth-logo-icon">üîë</span>
            <h1 class="auth-title">M·∫≠t kh·∫©u m·ªõi</h1>
            <p class="auth-subtitle">Vui l√≤ng thi·∫øt l·∫≠p m·∫≠t kh·∫©u m·∫°nh ƒë·ªÉ b·∫£o m·∫≠t t√†i kho·∫£n</p>
        </div>
        
        <form id="resetForm" onsubmit="handleReset(event)">
            <input type="hidden" id="token" value="@ViewBag.Token" />
            
            <div class="form-group">
                <label for="newPassword">M·∫≠t kh·∫©u m·ªõi</label>
                <input type="password" id="newPassword" name="newPassword" required class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6">
            </div>

            <div class="form-group">
                <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>

            <div id="resetMessage" class="success-message"></div>
            <div id="resetError" class="error-message"></div>
            
            <button type="submit" class="btn btn-primary btn-full">ƒê·ªïi m·∫≠t kh·∫©u</button>
        </form>
    </div>
</div>

@section Scripts {
<script>
    async function handleReset(e) {
        e.preventDefault();
        const messageDiv = document.getElementById('resetMessage');
        const errorDiv = document.getElementById('resetError');
        const submitBtn = e.target.querySelector('button[type="submit"]');
        
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const token = document.getElementById('token').value;

        if (newPassword !== confirmPassword) {
            errorDiv.textContent = 'M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp';
            return;
        }

        messageDiv.textContent = '';
        errorDiv.textContent = '';
        submitBtn.disabled = true;
        submitBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
        
        try {
            const res = await fetch('/api/auth/reset-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    token, 
                    newPassword, 
                    confirmPassword 
                })
            });
            
            const data = await res.json();
            
            if (res.ok && data.success) {
                messageDiv.textContent = 'ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng! Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ƒëƒÉng nh·∫≠p...';
                setTimeout(() => {
                    window.location.href = '/Account/Login';
                }, 2000);
            } else {
                errorDiv.textContent = data.message || 'ƒê·ªïi m·∫≠t kh·∫©u th·∫•t b·∫°i';
            }
        } catch (e) {
            errorDiv.textContent = 'L·ªói k·∫øt n·ªëi, vui l√≤ng th·ª≠ l·∫°i';
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'ƒê·ªïi m·∫≠t kh·∫©u';
        }
    }
</script>
}
