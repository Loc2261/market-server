@section Styles {
    <link rel="stylesheet" href="~/css/cart.css" asp-append-version="true" />
}

<!-- Header -->
<div class="cart-header">
    <div class="container">
        <a href="/Market" class="back-link">
            <i class="bi bi-arrow-left"></i>
            Ti·∫øp t·ª•c mua s·∫Øm
        </a>
        <h1 class="cart-title">Gi·ªè h√†ng</h1>
        <p class="cart-subtitle" id="itemCount">ƒêang t·∫£i...</p>
    </div>
</div>

<!-- Main Content -->
<div class="container mb-5">
    <div class="cart-layout">
        <!-- Cart Items -->
        <div>
            <div id="cartContainer">
                <div class="loading-container">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div>
            <div class="summary-card">
                <h2 class="summary-title">T·ªïng ƒë∆°n h√†ng</h2>
                
                <div class="summary-row">
                    <span class="summary-label">T·∫°m t√≠nh</span>
                    <span class="summary-value" id="subtotalValue">0‚Ç´</span>
                </div>
                
                <div class="summary-row">
                    <span class="summary-label">Ph√≠ v·∫≠n chuy·ªÉn</span>
                    <span class="summary-value text-success fw-600">Mi·ªÖn ph√≠</span>
                </div>
                
                <div class="summary-total">
                    <div class="summary-row" style="border: none; padding: 0;">
                        <span class="summary-label">T·ªïng c·ªông</span>
                        <span class="summary-value" id="totalValue">0‚Ç´</span>
                    </div>
                </div>
                
                <button class="btn-checkout" id="btnCheckout" onclick="goToCheckout()" disabled>
                    <span>Thanh to√°n</span>
                    <i class="bi bi-arrow-right"></i>
                </button>
                
                <button class="btn-clear" onclick="clearCart()">
                    <i class="bi bi-trash3"></i>
                    X√≥a gi·ªè h√†ng
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let cart = [];

    // Load cart on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadCart();
    });

    // Load cart from API
    async function loadCart() {
        try {
            const response = await fetch('/api/cart');
            if (!response.ok) throw new Error('Failed to load cart');
            
            cart = await response.json();
            renderCart();
        } catch (error) {
            console.error('Error loading cart:', error);
            showError('Kh√¥ng th·ªÉ t·∫£i gi·ªè h√†ng. Vui l√≤ng th·ª≠ l·∫°i.');
        }
    }

    // Render cart items
    function renderCart() {
        const container = document.getElementById('cartContainer');
        const itemCount = document.getElementById('itemCount');
        const btnCheckout = document.getElementById('btnCheckout');

        if (!cart || cart.length === 0) {
            container.innerHTML = `
                <div class="empty-cart">
                    <div class="empty-icon">üõí</div>
                    <h2 class="empty-title">Gi·ªè h√†ng tr·ªëng</h2>
                    <p class="empty-text">B·∫°n ch∆∞a th√™m s·∫£n ph·∫©m n√†o v√†o gi·ªè h√†ng</p>
                    <a href="/Market" class="btn-shop">
                        <i class="bi bi-shop"></i>
                        Kh√°m ph√° s·∫£n ph·∫©m
                    </a>
                </div>
            `;
            itemCount.textContent = 'Kh√¥ng c√≥ s·∫£n ph·∫©m';
            btnCheckout.disabled = true;
            updateSummary();
            return;
        }

        const itemText = cart.length === 1 ? 's·∫£n ph·∫©m' : 's·∫£n ph·∫©m';
        itemCount.textContent = `${cart.length} ${itemText}`;
        btnCheckout.disabled = false;

        container.innerHTML = `
            <div class="cart-items-container">
                ${cart.map(item => renderCartItem(item)).join('')}
            </div>
        `;

        updateSummary();
    }

    // Render single cart item
    function renderCartItem(item) {
        const itemTotal = item.price * item.quantity;
        const imageUrl = item.imageUrl || '/images/no-image.png';
        
        return `
            <div class="cart-item" data-id="${item.id}">
                <a href="/Market/Details/${item.productId}" class="item-image-wrapper">
                    <img src="${imageUrl}" alt="${escapeHtml(item.title)}" class="item-image">
                </a>
                
                <div class="item-details">
                    <a href="/Market/Details/${item.productId}" class="item-title">
                        ${escapeHtml(item.title)}
                    </a>
                    <div class="item-price">${formatPrice(item.price)}</div>
                    <div class="quantity-control">
                        <button class="qty-btn" onclick="updateQuantity(${item.id}, ${item.quantity - 1})" ${item.quantity <= 1 ? 'disabled' : ''}>
                            ‚àí
                        </button>
                        <span class="qty-value">${item.quantity}</span>
                        <button class="qty-btn" onclick="updateQuantity(${item.id}, ${item.quantity + 1})">
                            +
                        </button>
                    </div>
                </div>
                
                <div class="item-actions">
                    <button class="btn-delete" onclick="removeItem(${item.id})" title="X√≥a">
                        <i class="bi bi-trash3" style="font-size: 1.1rem;"></i>
                    </button>
                    <div class="item-subtotal">
                        <small class="text-muted">Th√†nh ti·ªÅn:</small><br>
                        <strong>${formatPrice(itemTotal)}</strong>
                    </div>
                </div>
            </div>
        `;
    }

    // Update quantity
    async function updateQuantity(itemId, newQuantity) {
        if (newQuantity < 1) return;
        
        try {
            const response = await fetch('/api/cart/update', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    cartItemId: itemId,
                    quantity: newQuantity
                })
            });

            if (!response.ok) throw new Error('Update failed');

            const item = cart.find(i => i.id === itemId);
            if (item) {
                item.quantity = newQuantity;
                renderCart();
            }
        } catch (error) {
            console.error('Error updating quantity:', error);
            showError('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng');
        }
    }

    // Remove item
    async function removeItem(itemId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) return;

        try {
            const response = await fetch(`/api/cart/${itemId}`, {
                method: 'DELETE'
            });

            if (!response.ok) throw new Error('Delete failed');

            cart = cart.filter(i => i.id !== itemId);
            renderCart();
        } catch (error) {
            console.error('Error removing item:', error);
            showError('Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m');
        }
    }

    // Clear cart
    async function clearCart() {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô gi·ªè h√†ng?')) return;

        try {
            const response = await fetch('/api/cart/clear', {
                method: 'DELETE'
            });

            if (!response.ok) throw new Error('Clear failed');

            cart = [];
            renderCart();
        } catch (error) {
            console.error('Error clearing cart:', error);
            showError('Kh√¥ng th·ªÉ x√≥a gi·ªè h√†ng');
        }
    }

    // Update summary
    function updateSummary() {
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        
        document.getElementById('subtotalValue').textContent = formatPrice(subtotal);
        document.getElementById('totalValue').textContent = formatPrice(subtotal);
    }

    // Go to checkout
    function goToCheckout() {
        if (cart.length === 0) {
            alert('Gi·ªè h√†ng tr·ªëng');
            return;
        }
        window.location.href = '/Market/Checkout';
    }

    // Format price
    function formatPrice(price) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(price);
    }

    // Escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Show error message
    function showError(message) {
        const container = document.getElementById('cartContainer');
        container.insertAdjacentHTML('afterbegin', `
            <div class="cart-alert error">
                <i class="bi bi-exclamation-circle"></i>
                <span>${message}</span>
            </div>
        `);
        
        setTimeout(() => {
            document.querySelector('.cart-alert')?.remove();
        }, 5000);
    }
</script>
}