@{
    ViewData["Title"] = "Đăng bán sản phẩm";
}

<div class="container">
    <div class="form-container">
        <h1>Đăng bán sản phẩm</h1>
        <form id="createProductForm" onsubmit="handleCreate(event)">
            <div class="form-group">
                <label for="title">Tiêu đề *</label>
                <input type="text" id="title" required class="form-input" placeholder="Nhập tiêu đề sản phẩm">
            </div>
            <div class="form-group">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <label for="description">Mô tả *</label>
                    <button type="button" class="btn btn-sm btn-link text-decoration-none" id="btnEnhanceDesc" onclick="enhanceDescription()">
                        <i class="bi bi-stars"></i> Viết hay hơn với AI
                    </button>
                </div>
                <textarea id="description" required class="form-textarea" placeholder="Mô tả chi tiết sản phẩm"></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="price">Giá (VNĐ) *</label>
                    <input type="number" id="price" required class="form-input" placeholder="Nhập giá" min="0">
                </div>
                <div class="form-group">
                    <label for="category">Danh mục</label>
                    <select id="category" class="form-select">
                        <option value="">Chọn danh mục</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Khu vực bán hàng (Tỉnh/Thành, Quận/Huyện) *</label>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <select id="provinceSelect" class="form-select" onchange="onProvinceChange(this)">
                                <option value="">Tỉnh/Thành</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select id="districtSelect" class="form-select" disabled onchange="onDistrictChange(this)">
                                <option value="">Quận/Huyện</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select id="wardSelect" class="form-select" disabled>
                                <option value="">Phường/Xã</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Hình ảnh sản phẩm</label>
                <div class="drop-zone" id="dropZone">
                    <i class="bi bi-cloud-arrow-up"></i>
                    <p>Kéo thả ảnh vào đây hoặc click để chọn file</p>
                    <p class="text-muted small mt-1">Hỗ trợ Paste (Ctrl+V) ảnh trực tiếp</p>
                    <input type="file" id="imageFile" accept="image/*" multiple onchange="handleFileInput(this)">
                </div>
                <div id="filePreview" class="mt-2 d-flex flex-wrap gap-2"></div>
                
                <label for="imageUrls" class="mt-3">Hoặc nhập danh sách URL hình ảnh (mỗi dòng một link)</label>
                <textarea id="imageUrls" class="form-textarea mt-2" placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.jpg" rows="3" oninput="previewUrls(this)"></textarea>
                <div id="urlPreview" class="mt-2 d-flex flex-wrap gap-2"></div>
            </div>
            <div id="createError" class="error-message"></div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="btnSubmit">Đăng bán</button>
                <a href="/Market" class="btn btn-outline">Hủy</a>
            </div>
        </form>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/create-product.css" asp-append-version="true" />
}

@section Scripts {
<script>
    async function loadCategories() {
        try {
            const res = await fetch('/api/categories');
            if (res.ok) {
                const categories = await res.json();
                const select = document.getElementById('category');
                categories.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    select.appendChild(opt);
                });
            }
        } catch (e) {
            console.error('Failed to load categories');
        }
    }

    // --- LOCATION LOGIC ---
    const PROVINCE_API = "https://provinces.open-api.vn/api/";
    
    async function initLocation() {
        try {
            const res = await fetch(PROVINCE_API + '?depth=1');
            const data = await res.json();
            const select = document.getElementById('provinceSelect');
            data.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.code;
                opt.text = p.name;
                opt.dataset.name = p.name;
                select.appendChild(opt);
            });
        } catch(e) { console.error("Lỗi load tỉnh thành:", e); }
    }

    async function onProvinceChange(el) {
        const code = el.value;
        const distSelect = document.getElementById('districtSelect');
        const wardSelect = document.getElementById('wardSelect');
        distSelect.innerHTML = '<option value="">Quận/Huyện</option>';
        wardSelect.innerHTML = '<option value="">Phường/Xã</option>';
        wardSelect.disabled = true;

        if (!code) { distSelect.disabled = true; return; }

        try {
            const res = await fetch(`${PROVINCE_API}p/${code}?depth=2`);
            const data = await res.json();
            data.districts.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.code;
                opt.text = d.name;
                opt.dataset.name = d.name;
                distSelect.appendChild(opt);
            });
            distSelect.disabled = false;
        } catch(e) { console.error("Lỗi load huyện:", e); }
    }

    async function onDistrictChange(el) {
        const code = el.value;
        const wardSelect = document.getElementById('wardSelect');
        wardSelect.innerHTML = '<option value="">Phường/Xã</option>';
        
        if (!code) { wardSelect.disabled = true; return; }

        try {
            const res = await fetch(`${PROVINCE_API}d/${code}?depth=2`);
            const data = await res.json();
            data.wards.forEach(w => {
                 const opt = document.createElement('option');
                 opt.value = w.code;
                 opt.text = w.name;
                 opt.dataset.name = w.name;
                 wardSelect.appendChild(opt);
            });
            wardSelect.disabled = false;
        } catch(e) { console.error("Lỗi load xã:", e); }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadCategories();
        initLocation();
    });

    // AI Feature: Suggest Price
    const dataTransfer = new DataTransfer();

    function handleFileInput(input) {
        if (input.files.length > 0) {
            handleFiles(input.files);
        }
    }

    function handleFiles(files) {
        const imageFileEl = document.getElementById('imageFile');
        Array.from(files).forEach(file => {
            if (file.type.startsWith('image/')) {
                // Avoid duplicates if needed, but for simplicity just add
                dataTransfer.items.add(file);
            }
        });
        imageFileEl.files = dataTransfer.files;
        previewImages(imageFileEl);
    }

    function previewImages(input) {
        const preview = document.getElementById('filePreview');
        preview.innerHTML = '';
        if (input.files) {
            Array.from(input.files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.style.position = 'relative';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.cssText = 'width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd;';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '<i class="bi bi-x"></i>';
                    removeBtn.style.cssText = 'position: absolute; top: -5px; right: -5px; width: 24px; height: 24px; border-radius: 50%; background: #ef4444; color: white; border: none; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center;';
                    removeBtn.onclick = (event) => {
                        event.preventDefault();
                        removeFile(index);
                    };

                    div.appendChild(img);
                    div.appendChild(removeBtn);
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }
    }

    function removeFile(index) {
        const imageFileEl = document.getElementById('imageFile');
        const newDataTransfer = new DataTransfer();
        const files = Array.from(dataTransfer.files);
        files.splice(index, 1);
        
        // Reset global dataTransfer
        while(dataTransfer.items.length > 0) dataTransfer.items.remove(0);
        files.forEach(file => {
            newDataTransfer.items.add(file);
            dataTransfer.items.add(file);
        });

        imageFileEl.files = newDataTransfer.files;
        previewImages(imageFileEl);
    }

    // Drag & Drop
    const dropZone = document.getElementById('dropZone');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
    });

    dropZone.addEventListener('drop', e => {
        handleFiles(e.dataTransfer.files);
    }, false);

    // Paste from clipboard
    document.addEventListener('paste', e => {
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                const file = item.getAsFile();
                handleFiles([file]);
            }
        }
    });

    function previewUrls(textarea) {
        const preview = document.getElementById('urlPreview');
        preview.innerHTML = '';
        const urls = textarea.value.split('\n').filter(u => u.trim() !== '');
        urls.forEach(url => {
            const img = document.createElement('img');
            img.src = url.trim();
            img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd;';
            img.onerror = () => img.remove();
            preview.appendChild(img);
        });
    }

    // AI Feature: Detect Category
    async function detectCategory() {
        const title = document.getElementById('title').value;
        const description = document.getElementById('description').value;
        
        if (!title) return;

        try {
            const res = await fetch('/api/ai/detect-category', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, description })
            });

            if (res.ok) {
                const data = await res.json();
                const select = document.getElementById('category');
                
                let found = false;
                for(let i=0; i<select.options.length; i++) {
                    if (select.options[i].value === data.category && data.confidence > 0.4) {
                        select.selectedIndex = i;
                        found = true;
                        break;
                    }
                }
                
                if (found) {
                    select.classList.add('is-valid');
                    setTimeout(() => select.classList.remove('is-valid'), 2000);
                }
            }
        } catch (e) {
            console.error(e);
        }
    }

    // AI Feature: Enhance Description
    async function enhanceDescription() {
        const description = document.getElementById('description').value;
        const category = document.getElementById('category').value;
        
        if (!description) {
            alert('Vui lòng nhập mô tả sơ bộ trước khi nhờ AI viết lại!');
            return;
        }

        const btn = document.getElementById('btnEnhanceDesc');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang viết...';
        btn.disabled = true;

        try {
            const res = await fetch('/api/ai/enhance-description', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ originalDescription: description, category })
            });

            if (res.ok) {
                const data = await res.json();
                document.getElementById('description').value = data.description;
            } else {
                alert('AI đang bận, vui lòng thử lại sau.');
            }
        } catch (e) {
            console.error(e);
            alert('Lỗi kết nối đến dịch vụ AI.');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    document.getElementById('title').addEventListener('blur', detectCategory);

    async function handleCreate(e) {
        e.preventDefault();
        const errorDiv = document.getElementById('createError');
        const btnSubmit = document.getElementById('btnSubmit');
        
        errorDiv.textContent = '';
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Đang xử lý...';
        
        const title = document.getElementById('title').value;
        const description = document.getElementById('description').value;
        const price = document.getElementById('price').value;
        const categoryId = document.getElementById('category').value;
        
        const pEl = document.getElementById('provinceSelect');
        const dEl = document.getElementById('districtSelect');
        const wEl = document.getElementById('wardSelect');
        
        const province = pEl.options[pEl.selectedIndex]?.dataset.name || "";
        const district = dEl.options[dEl.selectedIndex]?.dataset.name || "";
        const ward = wEl.options[wEl.selectedIndex]?.dataset.name || "";
        
        const location = province ? `${ward ? ward + ', ' : ''}${district ? district + ', ' : ''}${province}` : "";

        const imageFileEl = document.getElementById('imageFile');
        const imageUrlsString = document.getElementById('imageUrls').value;
        const imageUrls = imageUrlsString.split('\n').map(u => u.trim()).filter(u => u !== '');

        if (!categoryId) {
            errorDiv.textContent = 'Vui lòng chọn danh mục';
            btnSubmit.disabled = false;
            btnSubmit.innerHTML = 'Đăng bán';
            return;
        }

        const formData = new FormData();
        formData.append('Title', title);
        formData.append('Description', description);
        formData.append('Price', price);
        formData.append('CategoryId', categoryId);
        formData.append('Location', location);
        
        imageUrls.forEach(url => formData.append('ImageUrls', url));
        if (imageFileEl.files.length > 0) {
            Array.from(imageFileEl.files).forEach(file => formData.append('ImageFiles', file));
        }

        try {
            const res = await fetch('/api/products', {
                method: 'POST',
                body: formData // Fetch automatically sets Content-Type to multipart/form-data
            });
            
            if (res.ok) {
                const product = await res.json();
                window.location.href = `/Market/Details/${product.id}`;
            } else if (res.status === 401) {
                window.location.href = '/Account/Login';
            } else {
                const err = await res.json();
                errorDiv.textContent = err.message || 'Không thể đăng sản phẩm';
                if (err.errors) {
                    // Show validation errors
                    const details = Object.values(err.errors).flat().join('\n');
                    errorDiv.textContent += '\n' + details;
                }
            }
        } catch (e) {
            errorDiv.textContent = 'Lỗi kết nối: ' + e.message;
        } finally {
            btnSubmit.disabled = false;
            btnSubmit.innerHTML = 'Đăng bán';
        }
    }
</script>
}
