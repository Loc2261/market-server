@{
    ViewData["Title"] = "Theo dõi đơn hàng";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h2 class="text-center fw-bold mb-4">Theo dõi đơn hàng</h2>
            
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body p-4">
                    <form id="trackForm" class="input-group mb-3">
                        <input type="text" id="orderIdInput" class="form-control form-control-lg" placeholder="Nhập mã đơn hàng (VD: 123)" required>
                        <button class="btn btn-primary px-4" type="submit">Theo dõi</button>
                    </form>
                    <div class="text-muted small text-center">Nhập mã đơn hàng của bạn để xem trạng thái chi tiết</div>
                </div>
            </div>

            <div id="trackingResult" class="d-none">
                <!-- Result loaded here -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    document.getElementById('trackForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const orderId = document.getElementById('orderIdInput').value;
        await trackOrder(orderId);
    });

    async function trackOrder(id) {
        const resEnv = document.getElementById('trackingResult');
        resEnv.innerHTML = '<div class="text-center"><div class="spinner-border text-primary"></div></div>';
        resEnv.classList.remove('d-none');

        try {
            const res = await fetch(`/api/orders/${id}`);
            if (!res.ok) {
                resEnv.innerHTML = '<div class="alert alert-danger">Không tìm thấy đơn hàng này hoặc bạn không có quyền xem.</div>';
                return;
            }
            const order = await res.json();
            
             resEnv.innerHTML = `
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="m-0 fw-bold">Đơn hàng #${order.id}</h5>
                            <span class="badge bg-primary fs-6">${getStatusText(order.status)}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <div class="small text-muted mb-2">Trạng thái hiện tại:</div>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: ${getProgress(order.status)}%"></div>
                            </div>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="text-muted small">Người nhận</div>
                                <div class="fw-bold">${escapeHtml(order.shippingAddress.fullName)}</div>
                            </div>
                             <div class="col-md-6">
                                <div class="text-muted small">Ngày đặt</div>
                                <div class="fw-bold">${new Date(order.orderDate).toLocaleString('vi-VN')}</div>
                            </div>
                        </div>
                        
                        <hr>
                        <a href="/Order/Details/${order.id}" class="btn btn-outline-primary w-100">Xem chi tiết đầy đủ</a>
                    </div>
                </div>
             `;

        } catch (e) {
             resEnv.innerHTML = '<div class="alert alert-danger">Lỗi kết nối.</div>';
        }
    }

    function getProgress(status) {
        if (status >= 4) return 100;
        if (status >= 3) return 75;
        if (status >= 1) return 50;
        return 25;
    }
    
    function getStatusText(status) {
        const texts = ['Chờ xác nhận', 'Đã xác nhận', 'Đang chuẩn bị', 'Đang giao', 'Đã giao hàng', 'Hoàn thành', 'Đã hủy', 'Đã hoàn tiền'];
        return texts[status] || 'Không rõ';
    }
</script>
}
