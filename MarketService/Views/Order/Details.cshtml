@{
    ViewData["Title"] = "Chi tiết đơn hàng";
}

<div class="container py-5">
    <div class="mb-4">
        <a href="/Order/MyOrders" class="text-decoration-none text-muted">
            <i class="bi bi-arrow-left me-1"></i>Trở lại danh sách
        </a>
    </div>

    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
    </div>

    <div id="orderDetails" class="d-none">
        <div class="row">
            <!-- Left Column: Order Info -->
            <div class="col-lg-8">
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="m-0 fw-bold">Chi tiết đơn hàng <span id="orderIdText" class="text-primary"></span></h5>
                            <span id="orderStatusBadge" class="badge bg-secondary">status</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Order Timeline (Simplified) -->
                        <div class="mb-4 pb-4 border-bottom">
                            <div class="progress" style="height: 4px;">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
                            </div>
                            <div class="d-flex justify-content-between mt-2 small text-muted">
                                <span>Đặt hàng</span>
                                <span>Xác nhận</span>
                                <span>Vận chuyển</span>
                                <span>Giao hàng</span>
                            </div>
                        </div>

                        <!-- Product List -->
                        <div id="productList"></div>
                    </div>
                </div>

                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3">Thông tin nhận hàng</h6>
                        <div id="shippingInfo" class="small text-muted">
                            <!-- Address loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Summary -->
            <div class="col-lg-4">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <h5 class="card-title fw-bold mb-4">Thanh toán</h5>
                        
                        <div class="d-flex justify-content-between mb-2 small">
                            <span>Tiền hàng</span>
                            <span id="subtotal">0 ₫</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2 small">
                            <span>Phí vận chuyển</span>
                            <span id="shippingFee">0 ₫</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between mb-4">
                            <span class="fw-bold">Tổng cộng</span>
                            <span class="fw-bold text-primary fs-4" id="totalAmount">0 ₫</span>
                        </div>

                        <div id="paymentInfo" class="alert alert-light border small mb-3">
                            <!-- Payment method & status -->
                        </div>

                        <div id="actions">
                            <!-- Cancel / Confirm Received buttons -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const orderId = @ViewBag.OrderId;

    async function loadDetails() {
        try {
            const res = await fetch(`/api/orders/${orderId}`);
            if (!res.ok) {
                alert('Không tìm thấy đơn hàng');
                window.location.href = '/Order/MyOrders';
                return;
            }
            const order = await res.json();
            renderOrder(order);
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('orderDetails').classList.remove('d-none');
        } catch (e) {
            console.error(e);
            alert('Lỗi tải đơn hàng');
        }
    }

    function renderOrder(order) {
        document.getElementById('orderIdText').textContent = '#' + order.id;
        
        const statusBadge = document.getElementById('orderStatusBadge');
        statusBadge.className = `badge ${getStatusBadge(order.status)}`;
        statusBadge.textContent = getStatusText(order.status);

        // Update progress bar based on status
        let progress = 0;
        if (order.status >= 0) progress = 25;
        if (order.status >= 1) progress = 50;
        if (order.status >= 3) progress = 75;
        if (order.status >= 4) progress = 100;
        document.getElementById('progressBar').style.width = progress + '%';

        // Products
        document.getElementById('productList').innerHTML = order.orderItems.map(item => `
            <div class="d-flex gap-3 mb-3">
                <img src="${item.productImageUrl || 'https://via.placeholder.com/60'}" class="rounded border" width="60" height="60" style="object-fit:cover">
                <div class="flex-grow-1">
                    <h6 class="mb-1"><a href="/Market/Details/${item.productId}" class="text-decoration-none text-dark">${escapeHtml(item.productName)}</a></h6>
                    <small class="text-muted">x${item.quantity}</small>
                </div>
                <div class="text-end">
                    <div class="fw-bold">${formatPrice(item.price)}</div>
                    <small class="text-muted">${formatPrice(item.subtotal)}</small>
                </div>
            </div>
        `).join('');

        // Address & Shipping
        if (order.shippingAddress) {
            let shippingHtml = `
                <div class="fw-bold text-dark mb-1">${escapeHtml(order.shippingAddress.fullName)}</div>
                <div class="mb-1">${order.shippingAddress.phone}</div>
                <div class="mb-2">${order.shippingAddress.addressLine}, ${order.shippingAddress.ward}, ${order.shippingAddress.district}, ${order.shippingAddress.province}</div>
            `;
            
            if (order.trackingNumber) {
                shippingHtml += `
                    <div class="mt-3 pt-3 border-top">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-muted small">Đơn vị vận chuyển:</span>
                            <span class="fw-bold">Giao Hàng Nhanh (GHN)</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">Mã vận đơn:</span>
                            <span class="fw-bold text-primary font-monospace">${order.trackingNumber}</span>
                        </div>
                        <div class="mt-2 text-end">
                            <a href="https://donhang.ghn.vn/?order_code=${order.trackingNumber}" target="_blank" class="btn btn-sm btn-outline-primary py-0" style="font-size: 0.8rem;">
                                <i class="bi bi-search me-1"></i>Tra cứu vận đơn
                            </a>
                        </div>
                        <div class="mt-2 small text-muted fst-italic">
                            * Lưu ý: Đây là đơn vị vận chuyển mô phỏng cho mục đích Demo.
                        </div>
                    </div>
                `;
            }
            
            if (order.note) {
                shippingHtml += `<div class="mt-2 text-warning"><i class="bi bi-sticky me-1"></i>Ghi chú: ${escapeHtml(order.note)}</div>`;
            }
            
            document.getElementById('shippingInfo').innerHTML = shippingHtml;
        }

        // Totals
        document.getElementById('subtotal').textContent = formatPrice(order.totalAmount);
        document.getElementById('shippingFee').textContent = formatPrice(order.shippingFee);
        document.getElementById('totalAmount').textContent = formatPrice(order.finalAmount);

        // Payment
        const paymentMethods = ['Thanh toán khi nhận hàng (COD)', 'VNPay', 'MoMo', 'Chuyển khoản'];
        const paymentStatuses = ['Chưa thanh toán', 'Đã thanh toán', 'Đã hoàn tiền', 'Thất bại'];
        
        document.getElementById('paymentInfo').innerHTML = `
            <div class="fw-bold mb-1">${paymentMethods[order.paymentMethod]}</div>
            <div class="${order.paymentStatus === 1 ? 'text-success' : 'text-danger'}">
                <i class="bi ${order.paymentStatus === 1 ? 'bi-check-circle' : 'bi-exclamation-circle'} me-1"></i>
                ${paymentStatuses[order.paymentStatus]}
            </div>
        `;

        // Actions
        const actionsDiv = document.getElementById('actions');
        let buttons = '';
        const currentUserId = @(User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "0");

        // Only Buyer can see these actions
        if (order.buyerId === currentUserId) {
            if (order.status === 0) { // Pending
                buttons += `<button onclick="cancelOrder()" class="btn btn-outline-danger w-100">Hủy đơn hàng</button>`;
            }
            else if (order.status === 4) { // Delivered
                buttons += `<button onclick="confirmReceived()" class="btn btn-success w-100 mb-2">Đã nhận được hàng</button>`;
                buttons += `<button class="btn btn-outline-primary w-100 disabled">Yêu cầu Trả hàng/Hoàn tiền</button>`;
            }
            else if (order.status === 5) { // Completed
                 buttons += `<a href="/Market/Details/${order.orderItems[0].productId}" class="btn btn-primary w-100">Mua lại</a>`;
            }
        }

        actionsDiv.innerHTML = buttons;
    }

    async function cancelOrder() {
        if (!confirm('Bạn có chắc chắn muốn hủy đơn hàng này?')) return;
        
        const reason = prompt("Lý do hủy đơn hàng:");
        if (!reason) return;

        try {
            const res = await fetch(`/api/orders/${orderId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason })
            });
            
            if (res.ok) {
                alert('Đã hủy đơn hàng');
                location.reload();
            } else {
                alert('Không thể hủy đơn hàng');
            }
        } catch (e) {
            console.error(e);
        }
    }

    async function confirmReceived() {
        if (!confirm('Xác nhận bạn đã nhận được hàng và hàng hóa không có vấn đề gì?')) return;

        try {
            const res = await fetch(`/api/orders/${orderId}/confirm-delivery`, { method: 'POST' });
            if (res.ok) {
                alert('Cảm ơn bạn đã xác nhận!');
                location.reload();
            } else {
                alert('Có lỗi xảy ra');
            }
        } catch (e) {
            console.error(e);
        }
    }

    // Helper functions (same as MyOrders)
    function getStatusBadge(status) {
        switch(status) {
            case 0: return 'bg-warning text-dark';
            case 1: return 'bg-info text-dark';
            case 2: return 'bg-primary';
            case 3: return 'bg-primary';
            case 4: return 'bg-success';
            case 5: return 'bg-success';
            case 6: return 'bg-danger';
            case 7: return 'bg-secondary';
            default: return 'bg-secondary';
        }
    }

    function getStatusText(status) {
        const texts = ['Chờ xác nhận', 'Đã xác nhận', 'Đang chuẩn bị', 'Đang giao', 'Đã giao hàng', 'Hoàn thành', 'Đã hủy', 'Đã hoàn tiền'];
        return texts[status] || 'Không rõ';
    }

    document.addEventListener('DOMContentLoaded', loadDetails);
</script>
}
