@{
    ViewData["Title"] = "Qu·∫£n l√Ω b√†i vi·∫øt";
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin.css" />
}

<div class="admin-body">
    <div class="admin-sidebar" style="position: sticky; top: 0;">
        <h3><i class="bi bi-shield-lock"></i> <span>Admin Panel</span></h3>
        <nav class="admin-nav">
            <a href="/Admin" class="admin-nav-link">
                <i class="bi bi-speedometer2"></i> <span>Dashboard</span>
            </a>
            <a href="/Admin/Users" class="admin-nav-link">
                <i class="bi bi-people"></i> <span>Qu·∫£n l√Ω Users</span>
            </a>
            <a href="/Admin/Products" class="admin-nav-link">
                <i class="bi bi-box-seam"></i> <span>Qu·∫£n l√Ω S·∫£n ph·∫©m</span>
            </a>
            <a href="/Admin/Posts" class="admin-nav-link active">
                <i class="bi bi-file-earmark-post"></i> <span>Qu·∫£n l√Ω B√†i vi·∫øt</span>
            </a>
            <a href="/Admin/Categories" class="admin-nav-link">
                <i class="bi bi-tags"></i> <span>Qu·∫£n l√Ω Danh m·ª•c</span>
            </a>
            <hr style="border-top: 1px solid rgba(255,255,255,0.1); margin: 1rem 0;">
            <a href="/" class="admin-nav-link">
                <i class="bi bi-house"></i> <span>V·ªÅ trang ch·ªß</span>
            </a>
        </nav>
    </div>

    <div class="admin-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 fw-bold mb-0">üìù Qu·∫£n l√Ω b√†i vi·∫øt</h1>
                <p class="text-muted small mb-0">Gi√°m s√°t v√† qu·∫£n l√Ω n·ªôi dung c·ªông ƒë·ªìng.</p>
            </div>
            <div class="input-group" style="max-width: 300px;">
                <input type="text" id="postSearch" class="form-control form-control-sm" placeholder="T√¨m ti√™u ƒë·ªÅ..." onkeyup="filterPosts()">
                <button class="btn btn-outline-secondary btn-sm" onclick="filterPosts()"><i class="bi bi-search"></i></button>
            </div>
        </div>

        <div class="admin-card">
            <div class="admin-card-header">
                <h5 class="m-0 fw-bold">Danh s√°ch B√†i vi·∫øt</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>B√†i vi·∫øt</th>
                                <th>T√°c gi·∫£</th>
                                <th>T∆∞∆°ng t√°c</th>
                                <th>Ng√†y ƒëƒÉng</th>
                                <th class="text-end">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="postsBody">
                            <tr>
                                <td colspan="5" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Pagination Container -->
        <div id="paginationContainerPosts" class="p-3"></div>
    </div>
</div>

@section Scripts {
<script src="~/js/pagination.js"></script>
<script>
    let allPosts = [];
    let currentPage = 1;
    let totalPages = 1;

    async function loadPosts(page = 1) {
        currentPage = page;
        const search = document.getElementById('postSearch').value;
        try {
            const res = await fetch(`/api/admin/posts?page=${page}&pageSize=10&search=${encodeURIComponent(search)}`, { credentials: 'include' });
            if (!res.ok) throw new Error('API error');

            const data = await res.json();
            
            allPosts = Array.isArray(data) ? data : (data.items || data.Items || []);
            totalPages = data.totalPages || data.TotalPages || 1;

            if (allPosts.length === 0) {
                document.getElementById('postsBody').innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt n√†o</td></tr>';
            } else {
                renderPosts(allPosts);
            }
            
            renderPagination('paginationContainerPosts', currentPage, totalPages, (newPage) => {
                loadPosts(newPage);
            });
        } catch (e) {
            console.error(e);
            document.getElementById('postsBody').innerHTML = '<tr><td colspan="5" class="text-center py-4 text-danger">Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p ho·∫∑c l·ªói k·∫øt n·ªëi.</td></tr>';
        }
    }

    function renderPosts(posts) {
        document.getElementById('postsBody').innerHTML = posts.map(p => `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        ${p.imageUrl ? `<img src="${p.imageUrl}" class="rounded me-3" style="width: 50px; height: 50px; object-fit: cover;">` : `<div class="rounded me-3 bg-light d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;"><i class="bi bi-image text-muted"></i></div>`}
                        <div>
                            <div class="fw-bold text-truncate" style="max-width: 300px;">${escapeHtml(p.title)}</div>
                            <div class="text-muted small">${escapeHtml(p.content.substring(0, 50))}...</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="fw-semibold">&#64;${escapeHtml(p.authorName)}</span>
                </td>
                <td>
                    <div class="small text-muted">
                        <span class="me-2"><i class="bi bi-heart"></i> ${p.likesCount}</span>
                        <span><i class="bi bi-chat"></i> ${p.commentsCount}</span>
                    </div>
                </td>
                <td class="text-muted small">${new Date(p.createdAt).toLocaleDateString('vi-VN')}</td>
                <td class="text-end">
                    <div class="btn-group">
                        <button onclick="deletePost(${p.id})" class="btn btn-outline-danger btn-sm btn-admin" title="X√≥a b√†i vi·∫øt">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function filterPosts() {
        loadPosts(1);
    }

    async function deletePost(id) {
        if (!confirm('X√°c nh·∫≠n x√≥a b√†i vi·∫øt n√†y?')) return;
        try {
            const res = await fetch(`/api/admin/posts/${id}`, { method: 'DELETE', credentials: 'include' });
            if (res.ok) {
                showToast('ƒê√£ x√≥a b√†i vi·∫øt', 'success');
                loadPosts();
            } else {
                alert('L·ªói khi x√≥a b√†i vi·∫øt');
            }
        } catch (e) {
            alert('L·ªói k·∫øt n·ªëi');
        }
    }

    document.addEventListener('DOMContentLoaded', loadPosts);
</script>
}
