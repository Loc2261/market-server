@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin.css" />
}

<div class="admin-body">
    <div class="admin-sidebar" style="position: sticky; top: 0;">
        <h3><i class="bi bi-shield-lock"></i> <span>Admin Panel</span></h3>
        <nav class="admin-nav">
            <a href="/Admin" class="admin-nav-link active">
                <i class="bi bi-speedometer2"></i> <span>Dashboard</span>
            </a>
            <a href="/Admin/Users" class="admin-nav-link">
                <i class="bi bi-people"></i> <span>Qu·∫£n l√Ω Users</span>
            </a>
            <a href="/Admin/Products" class="admin-nav-link">
                <i class="bi bi-box-seam"></i> <span>Qu·∫£n l√Ω S·∫£n ph·∫©m</span>
            </a>
            <a href="/Admin/Posts" class="admin-nav-link">
                <i class="bi bi-file-earmark-post"></i> <span>Qu·∫£n l√Ω B√†i vi·∫øt</span>
            </a>
            <a href="/Admin/Categories" class="admin-nav-link">
                <i class="bi bi-tags"></i> <span>Qu·∫£n l√Ω Danh m·ª•c</span>
            </a>
            <hr style="border-top: 1px solid rgba(255,255,255,0.1); margin: 1rem 0;">
            <a href="/" class="admin-nav-link">
                <i class="bi bi-house"></i> <span>V·ªÅ trang ch·ªß</span>
            </a>
        </nav>
    </div>

    <div class="admin-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 fw-bold mb-0">üìä Dashboard Th·ªëng k√™</h1>
                <p class="text-muted small mb-0">D·ªØ li·ªáu c·∫≠p nh·∫≠t theo th·ªùi gian th·ª±c.</p>
            </div>
            <button class="btn btn-outline-primary btn-sm" onclick="loadStats()">
                <i class="bi bi-arrow-clockwise"></i> L√†m m·ªõi
            </button>
        </div>

        <!-- Stats Row -->
        <div class="row g-4 mb-5">
            <div class="col-md-3">
                <div class="stat-card bg-primary text-white">
                    <div class="card-body">
                        <div class="stat-label">T·ªïng ng∆∞·ªùi d√πng</div>
                        <div class="stat-value" id="statUsers">...</div>
                        <div class="small opacity-75"><i class="bi bi-people-fill"></i> Th√†nh vi√™n h·ªá th·ªëng</div>
                    </div>
                    <i class="bi bi-people stat-card-icon"></i>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card bg-success text-white">
                    <div class="card-body">
                        <div class="stat-label">S·∫£n ph·∫©m ƒëang b√°n</div>
                        <div class="stat-value" id="statProducts">...</div>
                        <div class="small opacity-75"><i class="bi bi-shop"></i> ƒêang ho·∫°t ƒë·ªông</div>
                    </div>
                    <i class="bi bi-box-seam stat-card-icon"></i>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card bg-info text-white">
                    <div class="card-body">
                        <div class="stat-label">ƒê∆°n h√†ng th√†nh c√¥ng</div>
                        <div class="stat-value" id="statOrders">...</div>
                        <div class="small opacity-75"><i class="bi bi-cart-check"></i> ƒê√£ ho√†n t·∫•t</div>
                    </div>
                    <i class="bi bi-receipt stat-card-icon"></i>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card bg-warning text-dark">
                    <div class="card-body">
                        <div class="stat-label">T·ªïng doanh thu</div>
                        <div class="stat-value" id="statRevenue">...</div>
                        <div class="small opacity-75"><i class="bi bi-currency-dollar"></i> Gi√° tr·ªã giao d·ªãch</div>
                    </div>
                    <i class="bi bi-cash-stack stat-card-icon"></i>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Recent Activities -->
            <div class="col-lg-12">
                <div class="admin-card">
                    <div class="admin-card-header d-flex justify-content-between align-items-center">
                        <h5 class="m-0 fw-bold"><i class="bi bi-clock-history me-2"></i>Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>Lo·∫°i</th>
                                        <th>Chi ti·∫øt</th>
                                        <th>Th·ªùi gian</th>
                                        <th>Tr·∫°ng th√°i</th>
                                    </tr>
                                </thead>
                                <tbody id="recentActivities">
                                    <tr>
                                        <td colspan="4" class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status"></div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    async function loadStats() {
        try {
            const res = await fetch('/api/admin/stats', { credentials: 'include' });
            const data = await res.json();
            
            animateValue("statUsers", 0, data.totalUsers, 1000);
            animateValue("statProducts", 0, data.activeProducts, 1000);
            animateValue("statOrders", 0, data.successfulOrders, 1000);
            
            document.getElementById('statRevenue').textContent = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(data.totalRevenue);
            
            displayActivities(data.recentActivities);
        } catch (e) {
            console.error('Error fetching admin stats:', e);
        }
    }

    function displayActivities(activities) {
        if (!activities || activities.length === 0) {
            document.getElementById('recentActivities').innerHTML = '<tr><td colspan="4" class="text-center py-4">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</td></tr>';
            return;
        }

        document.getElementById('recentActivities').innerHTML = activities.map(a => `
            <tr>
                <td>
                    <span class="badge ${a.type === 'User' ? 'bg-light-primary' : 'bg-light-success'} badge-admin">
                        <i class="bi bi-${a.type === 'User' ? 'person' : 'cart'} me-1"></i> ${a.type === 'User' ? 'Ng∆∞·ªùi d√πng' : 'ƒê∆°n h√†ng'}
                    </span>
                </td>
                <td><span class="fw-semibold">${escapeHtml(a.detail)}</span></td>
                <td class="text-muted small">${formatTimeAgo(a.time)}</td>
                <td>
                    <span class="badge bg-light-${getStatusColor(a.status)} badge-admin">${translateStatus(a.status)}</span>
                </td>
            </tr>
        `).join('');
    }

    function translateStatus(status) {
        const mapping = {
            'M·ªõi': 'M·ªõi',
            'Pending': 'Ch·ªù x·ª≠ l√Ω',
            'Confirmed': 'ƒê√£ x√°c nh·∫≠n',
            'Processing': 'ƒêang x·ª≠ l√Ω',
            'Shipping': 'ƒêang giao',
            'Delivered': 'ƒê√£ giao',
            'Completed': 'Ho√†n th√†nh',
            'Cancelled': 'ƒê√£ h·ªßy',
            'Refunded': 'ƒê√£ ho√†n ti·ªÅn'
        };
        return mapping[status] || status;
    }

    function getStatusColor(status) {
        if (status === 'M·ªõi' || status === 'Completed' || status === 'Delivered') return 'success';
        if (status === 'Pending' || status === 'Confirmed' || status === 'Processing' || status === 'Shipping') return 'warning';
        if (status === 'Cancelled' || status === 'Refunded') return 'danger';
        return 'info';
    }

    function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        if (start === end) {
            obj.innerHTML = end;
            return;
        }
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            }
        };
        window.requestAnimationFrame(step);
    }

    function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = Math.floor((now - date) / 1000);
        
        if (diff < 60) return 'V·ª´a xong';
        if (diff < 3600) return `${Math.floor(diff / 60)} ph√∫t tr∆∞·ªõc`;
        if (diff < 86400) return `${Math.floor(diff / 3600)} gi·ªù tr∆∞·ªõc`;
        return date.toLocaleDateString('vi-VN');
    }

    document.addEventListener('DOMContentLoaded', loadStats);
</script>
}
